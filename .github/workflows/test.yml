name: Test Just Commands

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_call:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Install Just
        uses: extractions/setup-just@v3

      - name: Build Image (just update)
        run: just update

      - name: Start Services (just up)
        run: just up

      - name: Wait for startup
        run: sleep 20

      - name: Verify Service Health (Port Check)
        run: |
          curl -v --retry 5 --retry-connrefused http://localhost:7681/vnc.html

      - name: Verify Container Processes
        run: |
          docker compose exec -T dwarf-fortress ps aux | grep -E "Xvfb|x11vnc|websockify|dwarfort"

      - name: Test Backup & Restore with Data Integrity
        run: |
          echo "1. Creating canary file in save directory..."
          docker compose exec -T dwarf-fortress sh -c "mkdir -p /opt/df/data/save && echo 'canary-content' > /opt/df/data/save/canary.txt"

          echo "2. Running backup..."
          just backup

          # Use the container's view of the backups folder to avoid sync issues on some CI runners
          BACKUP_FILE=$(docker compose exec -T dwarf-fortress sh -c "ls /opt/df/backups | grep '\.tar\.gz' | sort -r | head -n 1" | tr -d '\r')
          echo "Found backup: $BACKUP_FILE"

          if [ -z "$BACKUP_FILE" ]; then
            echo "FAILED: No backup file found!"
            exit 1
          fi

          echo "3. Deleting canary file..."
          docker compose exec -T dwarf-fortress sh -c "rm -f /opt/df/data/save/canary.txt"

          echo "4. Restoring backup..."
          just restore "$BACKUP_FILE" 0

          echo "5. Verifying command 'just backups' works..."
          just backups

          echo "6. Verifying canary file existence..."
          docker compose exec -T dwarf-fortress sh -c "cat /opt/df/data/save/canary.txt" | grep "canary-content"

      - name: Stop Services (just down)
        run: just down
